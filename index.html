<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmo AI - Next Gen Chat & Vision</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/bash.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
   
    <style>
        :root {
            --bg-color: #0a0a0f;
            --chat-bg: #0d0d12;
            --input-bg: #13131a;
            --border: #2a2a35;
            --accent: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.3);
            --accent-purple: #a855f7;
            --accent-purple-glow: rgba(168, 85, 247, 0.3);
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --nav-bg: rgba(13, 13, 18, 0.8);
            --sidebar-width: 300px;
            --glass-bg: rgba(19, 19, 26, 0.6);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; }
        
        body { 
            background: var(--bg-color); 
            color: var(--text-main); 
            height: 100vh; 
            display: flex; 
            flex-direction: row; 
            overflow: hidden;
            background-image: 
                radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(168, 85, 247, 0.05) 0%, transparent 50%);
        }

        /* Enhanced Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { 
            background: #3a3a45; 
            border-radius: 3px; 
            transition: background 0.2s;
        }
        ::-webkit-scrollbar-thumb:hover { background: #4a4a55; }

        /* SIDEBAR STYLES - Glassmorphism */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            flex-shrink: 0;
            white-space: nowrap;
        }
        .sidebar.closed { 
            width: 0; 
            border-right: none; 
            opacity: 0;
        }

        .sidebar-header {
            padding: 24px 20px;
            font-weight: 700;
            color: var(--text-main);
            font-size: 0.9rem;
            letter-spacing: 2px;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px solid var(--glass-border);
        }

        .new-chat-btn {
            margin: 20px 15px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex; 
            align-items: center; 
            gap: 10px;
            font-size: 0.9rem; 
            font-weight: 500;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        .new-chat-btn::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }
        .new-chat-btn:hover::before { left: 100%; }
        .new-chat-btn:hover { 
            border-color: var(--accent); 
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
        }

        .history-list {
            flex: 1; 
            overflow-y: auto; 
            padding: 0 12px;
        }
        .history-list ul { list-style: none; padding: 0; margin: 0; }
        
        .history-item {
            padding: 12px 14px; 
            border-radius: 10px; 
            cursor: pointer; 
            color: var(--text-muted);
            font-size: 0.85rem; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            transition: all 0.2s;
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            margin-bottom: 6px;
            border: 1px solid transparent;
            background: rgba(255,255,255,0.02);
        }
        .history-item:hover { 
            background: rgba(255,255,255,0.05); 
            color: #fff; 
            border-color: rgba(255,255,255,0.1);
        }
        .history-item.active { 
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(168, 85, 247, 0.1)); 
            color: #fff; 
            border-color: rgba(59, 130, 246, 0.3);
        }
        
        .delete-chat { 
            visibility: hidden; 
            font-size: 16px; 
            color: #f87171; 
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }
        .history-item:hover .delete-chat { visibility: visible; }
        .delete-chat:hover { 
            background: rgba(248, 113, 113, 0.1); 
        }

        .sidebar-footer {
            padding: 16px; 
            border-top: 1px solid var(--glass-border); 
            display: flex; 
            gap: 10px; 
            align-items: center;
            font-size: 0.85rem; 
            color: var(--text-muted); 
            cursor: pointer; 
            transition: all 0.2s;
            margin: 0 12px 12px 12px;
            border-radius: 8px;
        }
        .sidebar-footer:hover { 
            color: #f87171; 
            background: rgba(248, 113, 113, 0.05); 
        }

        /* MAIN CONTENT */
        .main-content {
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            height: 100%; 
            position: relative; 
            min-width: 0;
            background: var(--chat-bg);
        }

        /* Enhanced Navbar */
        .navbar {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            padding: 16px 24px; 
            background: var(--nav-bg); 
            border-bottom: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            z-index: 100;
        }
        .navbar .logo-area { 
            display: flex; 
            align-items: center; 
            gap: 16px; 
            font-weight: 700; 
            font-size: 1.3rem;
            background: linear-gradient(135deg, #fff 0%, #94a3b8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .nav-tabs {
            display: flex; 
            background: rgba(255,255,255,0.03); 
            padding: 4px; 
            border-radius: 12px; 
            gap: 4px; 
            margin-left: 30px;
            border: 1px solid var(--glass-border);
        }
        .nav-tab {
            padding: 8px 18px; 
            border-radius: 10px; 
            font-size: 0.85rem; 
            font-weight: 500; 
            cursor: pointer;
            color: var(--text-muted); 
            transition: all 0.3s ease; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }
        .nav-tab:hover { 
            color: #fff; 
            background: rgba(255,255,255,0.05); 
        }
        .nav-tab.active-chat { 
            background: linear-gradient(135deg, var(--accent), #2563eb);
            color: white;
            box-shadow: 0 4px 15px rgba(59, 130, 246, 0.3);
        }
        .nav-tab.active-gen { 
            background: linear-gradient(135deg, var(--accent-purple), #9333ea);
            color: white;
            box-shadow: 0 4px 15px rgba(168, 85, 247, 0.3);
        }

        /* Chat Container */
        #chat-container {
            flex: 1; 
            overflow-y: auto; 
            padding: 24px; 
            display: flex; 
            flex-direction: column; 
            gap: 24px;
            scroll-behavior: smooth;
            background: 
                radial-gradient(ellipse at top, rgba(59, 130, 246, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse at bottom right, rgba(168, 85, 247, 0.03) 0%, transparent 50%),
                var(--chat-bg);
        }

        .welcome-screen {
            height: 100%; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            text-align: center;
            animation: fadeIn 0.6s ease-out;
        }
        .welcome-screen.hidden { display: none; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 { 
            font-size: 3rem; 
            margin-bottom: 16px; 
            background: linear-gradient(135deg, #fff 0%, #3b82f6 50%, #a855f7 100%); 
            -webkit-background-clip: text; 
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            letter-spacing: -1px;
        }

        .welcome-subtitle {
            color: var(--text-muted);
            max-width: 500px;
            font-size: 1.1rem;
            line-height: 1.6;
        }

        .message-row { 
            display: flex; 
            width: 100%; 
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message-row.user { justify-content: flex-end; }
        .message-row.ai { justify-content: flex-start; }

        .bubble {
            max-width: 80%; 
            padding: 16px 20px; 
            border-radius: 20px; 
            font-size: 0.95rem; 
            line-height: 1.6; 
            word-wrap: break-word;
            position: relative;
        }
        .bubble.user { 
            background: linear-gradient(135deg, #808080e7, #979797e7);
            color: #fff; 
            border-bottom-right-radius: 4px;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.2);
        }
        .bubble.ai { 
            background: none; 
            border: 0.5px solid var(--glass-border);
            color: #e2e8f0; 
            width: 100%;
            border-bottom-left-radius: 4px;
        }

        /* Generated Image Container */
        .generated-image-container {
            position: relative; 
            display: inline-block; 
            overflow: hidden; 
            border-radius: 16px; 
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 60px rgba(168, 85, 247, 0.2);
            transition: transform 0.3s ease;
        }
        .generated-image-container:hover { transform: translateY(-2px); }
        
        .generated-image { 
            max-width: 100%; 
            max-height: 500px; 
            display: block; 
            transition: transform 0.5s ease; 
        }
        .generated-image-container:hover .generated-image { transform: scale(1.02); }
        
        .download-btn {
            position: absolute; 
            bottom: 16px; 
            right: 16px; 
            background: rgba(0,0,0,0.8); 
            color: white;
            padding: 12px; 
            border-radius: 12px; 
            cursor: pointer; 
            backdrop-filter: blur(10px); 
            opacity: 0; 
            transition: all 0.3s;
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border: 1px solid rgba(255,255,255,0.2);
        }
        .download-btn:hover { 
            background: var(--accent-purple); 
            transform: scale(1.1);
        }
        .generated-image-container:hover .download-btn { opacity: 1; }

        /* Spin Animation added for Loading icons */
        @keyframes spin {
            100% { transform: rotate(360deg); }
        }

        /* Input Area - Glassmorphism */
        .input-area {
            padding: 24px; 
            background: transparent;
            display: flex; 
            justify-content: center;
            position: relative;
        }
        
        .img-preview-container {
            position: absolute; 
            top: -80px; 
            left: 50%; 
            transform: translateX(-50%);
            background: var(--glass-bg); 
            padding: 8px; 
            border-radius: 12px; 
            border: 1px solid var(--glass-border); 
            display: none;
            backdrop-filter: blur(20px);
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10;
        }
        .img-preview-container img { 
            height: 64px; 
            border-radius: 8px; 
            display: block;
            object-fit: cover;
        }
        .remove-img { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            background: #ef4444; 
            color: white; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 14px; 
            padding: 4px; 
            box-shadow: 0 2px 10px rgba(239, 68, 68, 0.4);
            transition: transform 0.2s;
        }
        .remove-img:hover { transform: scale(1.1); }

        .input-box {
            width: 100%; 
            max-width: 800px; 
            background: var(--glass-bg);
            border: 1px solid var(--glass-border); 
            border-radius: 24px; 
            padding: 12px 16px;
            display: flex; 
            align-items: center; 
            gap: 12px; 
            transition: all 0.3s ease;
            backdrop-filter: blur(20px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
        }
        
        input { 
            flex: 1; 
            background: transparent; 
            border: none; 
            outline: none; 
            color: #fff; 
            font-size: 1rem; 
            padding: 8px;
            width: 100%;
        }
        input::placeholder { color: #64748b; }

        .gemini-input-area {
            background-color: #1e1f20; 
            border-radius: 32px;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            max-width: 800px;
            width: 100%;
            border: 1px solid transparent;
            transition: background-color 0.3s, border 0.3s;
        }
        .gemini-input-area:focus-within {
            background-color: #282a2c;
            border-color: #444746;
        }

        #chat-input-container {
            width: 100%;
            padding: 10px 20px;
            background: transparent;
            display: flex;
            justify-content: center;
        }

        .gemini-btn {
            color: #c4c7c5;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s, color 0.2s;
        }
        .gemini-btn:hover {
            background: rgba(255,255,255,0.08);
            color: #e3e3e3;
        }
        
        #send-btn { border: 1px solid #abababe7; }

        /* Code Block Styling */
        .code-wrapper {
            background: #0d1117;
            border-radius: 12px;
            margin: 16px 0;
            overflow: hidden;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid #30363d;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #161b22;
            padding: 12px 16px;
            border-bottom: 1px solid #30363d;
        }
        .language {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            color: #58a6ff;
            letter-spacing: 0.5px;
        }
        .copy-btn {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            color: #c9d1d9;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        .copy-btn:hover { 
            background: #30363d; 
            border-color: #8b949e;
        }
        .copy-btn.copied {
            background: #238636;
            border-color: #238636;
            color: white;
        }
        pre { margin: 0; padding: 16px; overflow-x: auto; background: #0d1117; }
        code { font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; line-height: 1.6; }
        .inline-code {
            background: rgba(255,255,255,0.1);
            color: #e2e8f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85em;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .bubble.ai h1, .bubble.ai h2, .bubble.ai h3 { margin: 20px 0 12px 0; color: #f8fafc; }
        .bubble.ai h1 { font-size: 1.5rem; border-bottom: 1px solid var(--glass-border); padding-bottom: 8px; }
        .bubble.ai h2 { font-size: 1.25rem; color: #94a3b8; }
        .bubble.ai h3 { font-size: 1.1rem; }
        .bubble.ai ul, .bubble.ai ol { margin: 12px 0; padding-left: 24px; }
        .bubble.ai li { margin: 6px 0; color: #cbd5e1; }
        .bubble.ai strong { color: #fff; font-weight: 600; }
        .bubble.ai em { color: #94a3b8; }
        #input-box{
          background-color: #0a0a0f;
        }
        /* Volume Icon Styling */
.speak-btn {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    margin-top: 10px;
    padding: 6px 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    color: var(--text-muted);
    cursor: pointer;
    font-size: 0.8rem;
    transition: all 0.2s;
}

.speak-btn:hover {
    background: rgba(59, 130, 246, 0.1);
    color: var(--accent);
}

.speak-btn.speaking {
    color: var(--accent-purple);
    border-color: var(--accent-purple);
    animation: pulse 1.5s infinite;
}

/* Mic Active Animation */
#mic-btn.listening {
    color: #ef4444;
    text-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
    animation: pulse 1.5s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}
    </style>
</head>
<body>
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <span>COSMO AI</span>
            <span class="material-icons-outlined icon-btn"
            onclick="document.getElementById('sidebar').classList.toggle('closed')">chevron_left</span>
        </div>
        <button class="new-chat-btn" onclick="startNewChat()">
            <span class="material-icons-outlined" style="font-size:18px;">add</span> New Chat
        </button>
        <div class="history-list">
            <ul id="history-ul"></ul>
        </div>
        <div class="sidebar-footer" onclick="clearAllChats()">
            <span class="material-icons-outlined">delete_sweep</span>
            <span>Clear All Chats</span>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <!-- NAVBAR -->
        <div class="navbar">
            <div class="logo-area">
                <span class="material-icons-outlined icon-btn" onclick="document.getElementById('sidebar').classList.toggle('closed')">menu</span>
                <span>Cosmo</span>
                
                <div class="nav-tabs">
                    <div class="nav-tab active-chat" id="tab-chat" onclick="switchMode('chat')">
                        <span class="material-icons-outlined" style="font-size:16px;">chat_bubble_outline</span> Chat
                    </div>
                    <div class="nav-tab" id="tab-gen" onclick="switchMode('gen')">
                        <span class="material-icons-outlined" style="font-size:16px;">auto_awesome</span> Imagine
                    </div>
                </div>
            </div>
        </div>

        <!-- CHAT AREA -->
        <div id="chat-container">
            <div class="welcome-screen" id="welcome">
                <h1>Cosmo AI</h1>
                <p class="welcome-subtitle">Experience next-gen AI and Image generation. Powered by advanced large language models.</p>
            </div>
        </div>

        <!-- INPUT AREA -->
        <div class="input-area">
            <div id="preview-box" class="img-preview-container">
                <span class="material-icons-outlined remove-img" onclick="removeImage()">close</span>
                <img id="preview-img" src="" alt="Preview">
            </div>
            
            <div id="chat-input-container">
                <div id="input-box" class="gemini-input-area">
    <input type="file" id="file-input" accept="image/*" style="display:none;" onchange="handleImageUpload(event)">
    
    <span class="material-icons-outlined gemini-btn" id="attach-btn" onclick="document.getElementById('file-input').click()" title="Attach Image">add</span>
    
    
    
    <input type="text" id="user-input" placeholder="Ask Cosmo..." autocomplete="off">
    
    
    <span class="material-icons-outlined gemini-btn" id="send-btn" title="Send Message" style="display: none;">arrow_upward</span>
</div>

            </div>
        </div>
        <footer style="text-align: center; padding: 7px; color: #a6a6a6e7;
        border-top: 1px solid #ffffff00; font-weight: bold; font font-family:
        Lora, cursive;">
    <p>Cosmo can make mistakes.</p>
  </footer>
    </div>

<script>
    // ========== CONFIG ==========
    const BYTEZ_API_KEY = "1c8b8f6a09dfb0928bbf5d7a4fb9f4ec"; 
    const GEMINI_API_KEY = "AIzaSyD3_HyZgiXcNbRBpObcmUGkHdvXja7pGbY";
    
    const SYSTEM_PROMPT = `You are Cosmo, an AI assistant developed by Ayaan a
    talented 13-year-old boy passionate about developing something new, a python
    programmer, web developer, frontend developer and an AI developer. Provide accurate, clear, and professional information. Adapt your tone
    to the user and maintain safety.`;

    // ========== DOM ELEMENTS ==========
    let chatContainer, userInput, sendBtn, welcomeScreen, inputBox, previewBox, previewImg, attachBtn, tabChat, tabGen, historyUl, modelSelect;

    // ========== STATE MANAGEMENT ==========
    let currentMode = 'chat';
    let currentChatId = null;
    let chatHistory = []; 
    let uploadedImageBase64 = null;

    // ========== INITIALIZATION ==========
    document.addEventListener('DOMContentLoaded', () => {
        chatContainer = document.getElementById('chat-container');
        userInput = document.getElementById('user-input');
        sendBtn = document.getElementById('send-btn');
        welcomeScreen = document.getElementById('welcome');
        inputBox = document.getElementById('input-box');
        previewBox = document.getElementById('preview-box');
        previewImg = document.getElementById('preview-img');
        attachBtn = document.getElementById('attach-btn');
        tabChat = document.getElementById('tab-chat');
        tabGen = document.getElementById('tab-gen');
        historyUl = document.getElementById('history-ul');
        modelSelect = document.getElementById('model-select');

        if (userInput) {
            userInput.addEventListener('input', toggleInputIcons);
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleSend();
                }
            });
        }
        if (sendBtn) sendBtn.addEventListener('click', handleSend);

        loadHistoryFromStorage();
        if (chatHistory.length === 0) {
            startNewChat();
        } else {
            loadChat(chatHistory[0].id);
        }
    });

    // ========== UI LOGIC ==========
    function toggleInputIcons() {
        if (userInput.value.trim().length > 0 || uploadedImageBase64) {
            if (sendBtn) sendBtn.style.display = 'flex';
        } else {
            if (sendBtn) sendBtn.style.display = 'none';
        }
    }

    function switchMode(mode) {
        currentMode = mode;
        const dropdownWrapper = document.getElementById('model-dropdown-wrapper');
        if (mode === 'chat') {
            tabChat.className = "nav-tab active-chat";
            tabGen.className = "nav-tab";
            if (dropdownWrapper) dropdownWrapper.style.opacity = "1";
            userInput.placeholder = "Message Cosmo AI...";
        } else {
            tabChat.className = "nav-tab";
            tabGen.className = "nav-tab active-gen";
            if (dropdownWrapper) dropdownWrapper.style.opacity = "0.3";
            userInput.placeholder = "Describe the image you want to generate...";
        }
    }

    function handleImageUpload(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                uploadedImageBase64 = e.target.result;
                previewImg.src = uploadedImageBase64;
                previewBox.style.display = 'block';
                toggleInputIcons();
            };
            reader.readAsDataURL(file);
        }
    }

    function removeImage() {
        uploadedImageBase64 = null;
        previewImg.src = "";
        previewBox.style.display = 'none';
        document.getElementById('file-input').value = "";
        toggleInputIcons();
    }

    // ========== VOICE FEATURES ==========
    function speakText(text, btn) {
        if (!('speechSynthesis' in window)) {
            console.warn("Text-to-speech is not supported in this browser.");
            alert("Sorry, your browser doesn't support text to speech.");
            return;
        }

        if (window.speechSynthesis.speaking && btn.classList.contains('speaking')) {
            window.speechSynthesis.cancel();
            resetSpeakButton(btn);
            return;
        }

        window.speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        
        document.querySelectorAll('.speak-btn.speaking').forEach(resetSpeakButton);
        
        btn.classList.add('speaking');
        btn.innerHTML = '<span class="material-icons-outlined" style="font-size:16px;">stop</span>';

        utterance.onend = () => {
            resetSpeakButton(btn);
        };

        utterance.onerror = (e) => {
            console.error("Speech synthesis error:", e);
            resetSpeakButton(btn);
        };

        window.speechSynthesis.speak(utterance);
    }

    function resetSpeakButton(btn) {
        if(btn) {
            btn.classList.remove('speaking');
            btn.innerHTML = '<span class="material-icons-outlined" style="font-size:16px;">volume_up</span>';
        }
    }

    let processAndRenderAIResponse = function(bubble, text) {
        let thoughtPart = "";
        let responsePart = text;

        const thinkRegex = /<think>([\s\S]*?)(?:<\/think>|$)/i;
        const match = text.match(thinkRegex);
        
        if (match) {
            thoughtPart = match[1].trim(); 
            responsePart = text.replace(thinkRegex, '').trim(); 
        } else {
            if (text.includes("\n\n")) {
                const paragraphs = text.split('\n\n');
                const firstPara = paragraphs[0].trim().toLowerCase();
                if (firstPara.startsWith("i should") || firstPara.startsWith("okay") || firstPara.startsWith("let me think")) {
                    thoughtPart = paragraphs[0];
                    responsePart = paragraphs.slice(1).join('\n\n').trim();
                }
            }
        }

        let html = "";
        
        if (thoughtPart && thoughtPart.length > 2) {
            html += `
                <details style="margin-bottom:12px; opacity:0.8; font-size:0.9rem; border:1px solid rgba(255,255,255,0.1); border-radius:12px; background: rgba(255,255,255,0.03);">
                    <summary style="cursor:pointer; padding:10px; color:var(--accent); font-weight:600; list-style:none; display:flex; align-items:center; gap:8px;">
                        <span class="material-icons-outlined" style="font-size:18px;">psychology</span> View Reasoning
                    </summary>
                    <div style="padding:0 12px 12px 12px; font-style:italic; color: #94a3b8;">${formatText(thoughtPart)}</div>
                </details>
            `;
        }
        
        if (responsePart) {
            html += `<div>${formatText(responsePart)}</div>`;
        }
        
        bubble.innerHTML = html;
        
        const speakBtn = document.createElement('button');
        speakBtn.className = 'speak-btn';
        speakBtn.innerHTML = '<span class="material-icons-outlined" style="font-size:16px;">volume_up</span>';
        
        let speechPart = responsePart.replace(/<think>[\s\S]*?<\/think>/gi, '').trim();
        speakBtn.onclick = () => speakText(speechPart, speakBtn);
        bubble.appendChild(speakBtn);
    };

    async function handleSend() {
        const text = userInput.value.trim();
        if (!text && !uploadedImageBase64) return;

        if (!currentChatId) startNewChat();

        welcomeScreen.classList.add('hidden');
        userInput.value = '';
        
        const currentImg = uploadedImageBase64;
        removeImage(); 
        toggleInputIcons();
        
        updateChatTitle(currentChatId, text || "Image");
        renderMessageBubble('user', text, currentImg);
        addToCurrentChatHistory('user', text, currentImg);

        if (currentMode === 'chat') {
            await handleChatRequest(text, currentImg);
        } else {
            await handleImageGenerationRequest(text);
        }
    }

    async function handleChatRequest(prompt, imgSource) {
        const aiBubble = addLoadingBubble("Thinking...", false);
        
        try {
            if (imgSource) {
                // Use Gemini API for Image Recognition
                const mimeType = imgSource.substring(imgSource.indexOf(':') + 1, imgSource.indexOf(';'));
                const base64Data = imgSource.substring(imgSource.indexOf(',') + 1);

                const payload = {
                    contents: [{
                        parts: [
                            { text: prompt || "Describe this image in detail." },
                            {
                                inlineData: {
                                    mimeType: mimeType,
                                    data: base64Data
                                }
                            }
                        ]
                    }],
                    systemInstruction: {
                        parts: [{ text: SYSTEM_PROMPT }]
                    }
                };

                const response = await
                fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.error?.message || "Gemini API error occurred.");
                }

                const finalString = data.candidates?.[0]?.content?.parts?.[0]?.text || "No response received.";
                
                processAndRenderAIResponse(aiBubble, finalString);
                addToCurrentChatHistory('ai', finalString, null);

            } else {
                // Use Qwen API for Text-only Chat
                const chat = chatHistory.find(c => c.id === currentChatId);
                const messages = [{ role: "system", content: SYSTEM_PROMPT }];

                chat.messages.forEach(msg => {
                    messages.push({
                        role: msg.role === 'ai' ? 'assistant' : 'user',
                        content: msg.text || "Image Data"
                    });
                });

                const response = await fetch("https://api.bytez.com/models/v2/Qwen/Qwen3-4B", {
                    method: 'POST',
                    headers: { 
                        'Authorization': BYTEZ_API_KEY,
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ 
                        messages: messages,
                        stream: false,
                        params: { temperature: 0.7, max_length: 2048 }
                    })
                });

                const data = await response.json();
                
                let rawData = (data.choices && data.choices[0] && data.choices[0].message) 
                              ? data.choices[0].message.content 
                              : (data.output || "");

                let finalString = "";
                if (typeof rawData === 'object' && rawData !== null) {
                    finalString = rawData.content || JSON.stringify(rawData);
                } else {
                    finalString = String(rawData || "No response.");
                }

                if (finalString.trim().startsWith('{')) {
                    try {
                        const parsed = JSON.parse(finalString);
                        finalString = parsed.content || finalString;
                    } catch(e) { }
                }

                processAndRenderAIResponse(aiBubble, finalString);
                addToCurrentChatHistory('ai', finalString, null);
            }

        } catch (error) {
            console.error("DEBUG ERROR:", error);
            aiBubble.innerHTML = `<b style="color:#ff5f56;">Error:</b> ${error.message}`;
        }
        scrollToBottom();
    }

    async function handleImageGenerationRequest(prompt) {
        const aiBubble = addLoadingBubble("Creating magic...", true);
        try {
            const response = await fetch("https://api.bytez.com/models/v2/dreamlike-art/dreamlike-photoreal-2.0", {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': BYTEZ_API_KEY
                },
                body: JSON.stringify({ text: prompt })
            });

            if (!response.ok) {
                const errData = await response.json().catch(() => ({}));
                throw new Error(errData.error || errData.message || "Generation failed with status: " + response.status);
            }

            const contentType = response.headers.get("content-type");
            let imageUrl;
            
            if (contentType && contentType.includes("application/json")) {
                const data = await response.json();
                const base64Data = data.output || data.image || data.result;
                if (!base64Data) throw new Error("API returned JSON without valid image data.");
                imageUrl = base64Data.startsWith('http') ? base64Data : 
                           (base64Data.startsWith('data:') ? base64Data : `data:image/png;base64,${base64Data}`);
            } else {
                const blob = await response.blob();
                imageUrl = URL.createObjectURL(blob);
            }
            
            aiBubble.innerHTML = `<div class="generated-image-container"><img class="generated-image" src="${imageUrl}" style="width:100%; border-radius:12px;"><a href="${imageUrl}" download="cosmo-art.png" class="download-btn"><span class="material-icons-outlined">download</span></a></div>`;
            addToCurrentChatHistory('ai', `[Image]`, imageUrl);
        } catch (error) {
            aiBubble.innerHTML = `<b style="color:#ff5f56;">Error:</b> ${error.message}`;
        }
        scrollToBottom();
    }

    // ========== HELPERS & STORAGE ==========
    function saveHistoryToStorage() { localStorage.setItem('cosmo_history', JSON.stringify(chatHistory)); renderSidebar(); }
    function loadHistoryFromStorage() {
        const stored = localStorage.getItem('cosmo_history');
        if (stored) chatHistory = JSON.parse(stored);
    }
    
    function startNewChat() {
        currentChatId = Date.now().toString();
        chatHistory.unshift({ id: currentChatId, title: "New Chat", messages: [] });
        chatContainer.innerHTML = '';
        chatContainer.appendChild(welcomeScreen);
        welcomeScreen.classList.remove('hidden');
        saveHistoryToStorage();
    }
    
    function loadChat(id) {
        const chat = chatHistory.find(c => c.id === id);
        if (!chat) return;
        currentChatId = id;
        
        chatContainer.innerHTML = ''; 
        chatContainer.appendChild(welcomeScreen);

        if (chat.messages.length > 0) {
            welcomeScreen.classList.add('hidden');
            chat.messages.forEach(msg => renderMessageBubble(msg.role, msg.text, msg.image));
        } else {
            welcomeScreen.classList.remove('hidden');
        }
        renderSidebar();
        scrollToBottom();
    }
    
    function renderSidebar() {
        historyUl.innerHTML = '';
        chatHistory.forEach(chat => {
            const li = document.createElement('li');
            li.className = `history-item ${chat.id === currentChatId ? 'active' : ''}`;
            li.innerHTML = `<span>${chat.title}</span><span class="material-icons-outlined delete-chat" onclick="deleteChat(event, '${chat.id}')">delete</span>`;
            li.onclick = () => loadChat(chat.id);
            historyUl.appendChild(li);
        });
    }

    function clearAllChats() {
        chatHistory = [];
        saveHistoryToStorage();
        startNewChat();
    }

    function renderMessageBubble(role, text, imgSource) {
        const row = document.createElement('div');
        row.className = `message-row ${role}`;
        const bubble = document.createElement('div');
        bubble.className = `bubble ${role}`;
        
        let htmlContent = '';
        
        if (role === 'ai') {
            if (imgSource) {
                bubble.innerHTML = `<div class="generated-image-container"><img class="generated-image" src="${imgSource}" style="width:100%; border-radius:12px;"><a href="${imgSource}" download="cosmo-art.png" class="download-btn"><span class="material-icons-outlined">download</span></a></div>`;
            } else {
                processAndRenderAIResponse(bubble, text);
            }
        } else {
            if (imgSource) {
                htmlContent += `<img src="${imgSource}" style="max-width:250px; border-radius:12px; margin-bottom:8px; display:block; border:1px solid rgba(255,255,255,0.1);">`;
            }
            if (text) {
                htmlContent += `<div>${escapeHTML(text)}</div>`;
            }
            bubble.innerHTML = htmlContent;
        }

        row.appendChild(bubble);
        chatContainer.appendChild(row);
        scrollToBottom();
    }

    function addLoadingBubble(text, isPurple) {
        const row = document.createElement('div');
        row.className = 'message-row ai';
        const bubble = document.createElement('div');
        bubble.className = 'bubble ai';
        const color = isPurple ? '#a855f7' : '#3b82f6';
        bubble.innerHTML = `<span style="color:${color}; display:flex; align-items:center; gap:8px;"><span class="material-icons-outlined" style="animation:spin 1.5s infinite linear;">refresh</span> ${text}</span>`;
        
        row.appendChild(bubble);
        chatContainer.appendChild(row);
        scrollToBottom();
        return bubble;
    }

    function escapeHTML(str) {
        return str.replace(/[&<>'"]/g, 
            tag => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;' }[tag] || tag)
        );
    }

    function formatText(text) {
        if (!text) return "";
        
        text = escapeHTML(text);

        const codeBlocks = [];
        text = text.replace(/```(\w+)?\n([\s\S]*?)```/g, (m, lang, code) => {
            codeBlocks.push(`<div class="code-wrapper"><div class="code-header"><span class="language">${lang || 'code'}</span><button class="copy-btn" onclick="copyCode(this)"><span class="material-symbols-outlined">content_copy</span> Copy</button></div><pre><code>${code.trim()}</code></pre></div>`);
            return `___CODE_BLOCK_${codeBlocks.length - 1}___`;
        });
        
        text = text.replace(/`([^`]+)`/g, '<span class="inline-code">$1</span>');
        text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        text = text.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        text = text.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        text = text.replace(/^# (.*$)/gim, '<h1>$1</h1>');
        text = text.replace(/\n/g, '<br>');

        codeBlocks.forEach((block, i) => {
            text = text.replace(`___CODE_BLOCK_${i}___`, block);
        });

        return text;
    }

    function copyCode(btn) {
        const code = btn.parentElement.nextElementSibling.innerText;
        navigator.clipboard.writeText(code).then(() => {
            btn.innerHTML = `<span class="material-symbols-outlined">check</span> Copied`;
            btn.classList.add('copied');
            setTimeout(() => {
                btn.innerHTML = `<span class="material-symbols-outlined">content_copy</span> Copy`;
                btn.classList.remove('copied');
            }, 2000);
        });
    }

    function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }
    
    function deleteChat(e, id) {
        e.stopPropagation();
        chatHistory = chatHistory.filter(c => c.id !== id);
        saveHistoryToStorage();
        if (currentChatId === id) startNewChat();
    }
    
    function addToCurrentChatHistory(role, text, image) {
        const chat = chatHistory.find(c => c.id === currentChatId);
        if (chat) chat.messages.push({ role, text, image });
        saveHistoryToStorage();
    }
    
    function updateChatTitle(id, msg) {
        const chat = chatHistory.find(c => c.id === id);
        if (chat && (chat.title === "New Chat" || chat.title === "")) {
            chat.title = msg.length > 20 ? msg.substring(0, 20) + "..." : msg;
        }
    }
</script>

</body>
</html>